<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>支付通道账户配置 - 示例</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../../assets/layui.css" media="all">
</head>
<body>

<div class="layui-card-header layui-card">
  <span class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">首页</a>
    <a><cite>支付配置</cite></a>
  </span>
</div>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-tab layui-tab-brief">
      <ul class="layui-tab-title">
        <li class="layui-this">支付通道账户</li>
      </ul>
      <div class="layui-tab-content">
        <!-- 操作按钮区 -->
        <div class="layui-row">
          <div class="layuiAdmin-btns" style="margin-bottom: 10px;">
            <button class="layui-btn" data-type="all" data-events="create">新增账户</button>
          </div>
        </div>

        <!-- 搜索表单 -->
        <div class="layui-row" style="margin-bottom:15px;">
          <div class="layui-form" style="float:right;">
            <div class="layui-form-item" style="margin:0;">
              <label class="layui-form-label">账户名称</label>
              <div class="layui-input-inline">
                <input type="text" name="accountName" id="accountName" autocomplete="off" class="layui-input">
              </div>
              <button id="search" class="layui-btn" data-type="reload">搜索</button>
            </div>
          </div>
        </div>

        <!-- 数据表格 -->
        <table id="accountList" lay-filter="accountList"></table>
      </div>
    </div>
  </div>
</div>

<!-- 操作按钮模板 -->
<script type="text/html" id="accountBar">
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="risk">风控</a>
  {{#  if(d.ifCode == 'alipay_qr_pc' || d.ifCode == 'alipay_qr_h5'){ }}
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="coll">分账</a>
  {{#  } }}
</script>

<script src="../../../assets/layui.js"></script>
<script>
layui.use(['table', 'form', 'admin', 'element'], function(){
  var table = layui.table
    ,$ = layui.$
    ,form = layui.form
    ,admin = layui.admin
    ,element = layui.element;

  // 渲染面包屑导航
  element.render('breadcrumb', 'breadcrumb');

  // 权限控制
  var authEdit = true;
  admin.req({
    type: 'get',
    url: '/api/mch_info/checkAuth',
    data: {
      access_token: layui.data(layui.setter.tableName).access_token,
      authAction: 'ROLE_PAY_PASSAGE_ACCOUNT_EDIT'
    },
    success: function(res){
      if(res.data == 'RET_SERVICE_PAGE_NO_AUTH'){
        authEdit = false;
        $(".layuiAdmin-btns .layui-btn").removeAttr("data-events");
      }
    }
  });

  // 状态显示模板函数
  var tplStatus = function(d){
    if(d.status == 0) {
      return "关闭";
    } else if(d.status == 1) {
      return "<span style='color: green'>开启</span>";
    }
    return d.status;
  };

  // 费率显示模板函数
  var tplRate = function(d){
    return "<span style='color: blue'>"+ d.passageRate+"% + " + d.passageFeeEvery + "</span>";
  };

  // 表格渲染配置
  table.render({
    elem: '#accountList',
    url: '/api/config/pay_passage_account/list',
    where: {
      access_token: layui.data(layui.setter.tableName).access_token
    },
    id: 'tableReload',
    cols: [[
      {field: 'id', title: '账户ID', width: 100},
      {field: 'accountName', title: '账户名称', width: 200},
      {field: 'ifCode', title: '接口代码', width: 150},
      {field: 'ifName', title: '接口名称', width: 200},
      {field: 'passageRate', title: '上游费率', width: 150, templet: tplRate},
      {field: 'status', title: '状态', width: 100, templet: tplStatus},
      {field: 'edite', width: 260, title: '操作', toolbar: '#accountBar'}
    ]],
    page: true,
    skin: 'line',
    limit: 20
  });

  // 搜索功能
  var active = {
    reload: function(){
      var accountName = $('#accountName').val();

      table.reload('tableReload', {
        page: { curr: 1 },
        where: {
          accountName: accountName
        }
      });
    },
    create: function(othis, type){
      if(!authEdit){
        layer.msg('没有操作权限', {icon: 2});
        return;
      }
      location.href = '#/config/pay_passage_account/create';
    }
  };

  $('.layuiAdmin-btns .layui-btn').on('click', function(){
    var othis = $(this)
      ,thisEvent = othis.data('events')
      ,type = othis.data('type');
    active[thisEvent] ? active[thisEvent].call(this, othis, type) : '';
  });

  $('#search').on('click', function(){
    var type = $(this).data('type');
    active[type] ? active[type].call(this) : '';
  });

  // 行操作事件监听
  table.on('tool(accountList)', function(obj){
    var data = obj.data;

    if(!authEdit){
      layer.msg('没有操作权限', {icon: 2});
      return;
    }

    if(obj.event === 'edit'){
      location.href = '#/config/pay_passage_account/update/id=' + data.id;
    } else if(obj.event === 'risk'){
      location.href = '#/config/pay_passage_account/risk_set/id=' + data.id;
    } else if(obj.event === 'coll'){
      location.href = '#/config/pay_passage_account/cash_coll_set/id=' + data.id;
    }
  });
});
</script>
</body>
</html>
