<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>API 集成模板 - LayuiAdmin admin.req</title>
</head>
<body>

<!--
  LayuiAdmin API 集成标准模板
  基于 716+ 实际项目 HTML 文件分析
  统一使用 admin.req 进行 API 调用
-->

<script>
layui.use(['admin', 'table', 'form', 'layer'], function(){
  var admin = layui.admin;
  var table = layui.table;
  var form = layui.form;
  var layer = layui.layer;
  var $ = layui.$;

  // ============================================
  // 1. GET 请求示例 - 获取数据
  // ============================================
  function getData(id) {
    admin.req({
      type: 'get',
      url: layui.setter.baseUrl + '/api/getData',
      data: {id: id},
      success: function(res){
        if(res.code == 0){
          // 处理成功响应
          console.log('数据获取成功:', res.data);
          // 填充表单或更新UI
          $('#id').val(res.data.id);
          $('#name').val(res.data.name);
        } else {
          layer.alert(res.msg || '获取数据失败', {title: '错误提示'});
        }
      },
      error: function(err){
        layer.alert(JSON.stringify(err), {title: '请求错误'});
      }
    });
  }

  // ============================================
  // 2. POST 请求示例 - 提交数据
  // ============================================
  function submitData(formData) {
    admin.req({
      type: 'post',
      url: layui.setter.baseUrl + '/api/saveData',
      data: formData,
      success: function(res){
        if(res.code == 0){
          layer.msg('保存成功', {icon: 1});
          // 关闭弹窗或跳转
          layer.closeAll();
          // 刷新表格
          table.reload('tableReload');
        } else {
          layer.alert(res.msg || '保存失败', {title: '错误提示'});
        }
      },
      error: function(err){
        layer.alert(JSON.stringify(err), {title: '请求错误'});
      }
    });
  }

  // ============================================
  // 3. DELETE 请求示例 - 删除数据
  // ============================================
  function deleteData(id) {
    layer.confirm('确定要删除吗？', {icon: 3, title:'提示'}, function(index){
      admin.req({
        type: 'post',
        url: layui.setter.baseUrl + '/api/deleteData',
        data: {id: id},
        success: function(res){
          if(res.code == 0){
            layer.msg('删除成功', {icon: 1});
            layer.close(index);
            // 刷新表格
            table.reload('tableReload');
          } else {
            layer.msg(res.msg || '删除失败', {icon: 2});
          }
        }
      });
    });
  }

  // ============================================
  // 4. 批量操作示例
  // ============================================
  function batchDelete(ids) {
    layer.confirm('确定要删除选中的数据吗？', {icon: 3, title:'提示'}, function(index){
      admin.req({
        type: 'post',
        url: layui.setter.baseUrl + '/api/batchDelete',
        data: {ids: ids}, // ids: "1,2,3" 或 ids: [1,2,3]
        success: function(res){
          if(res.code == 0){
            layer.msg('删除成功，共删除 ' + res.data.count + ' 条', {icon: 1});
            layer.close(index);
            table.reload('tableReload');
          } else {
            layer.msg(res.msg || '删除失败', {icon: 2});
          }
        }
      });
    });
  }

  // ============================================
  // 5. 导出数据示例
  // ============================================
  function exportData(params) {
    admin.req({
      type: 'get',
      url: layui.setter.baseUrl + '/api/exportData',
      data: params,
      success: function(res){
        if(res.code == 0){
          // 下载文件
          window.location.href = res.data.fileUrl;
          layer.msg('导出成功', {icon: 1});
        } else {
          layer.msg(res.msg || '导出失败', {icon: 2});
        }
      }
    });
  }

  // ============================================
  // 6. 表格数据加载示例
  // ============================================
  table.render({
    elem: '#dataTable',
    url: layui.setter.baseUrl + '/api/list',
    method: 'post', // 默认get，可设置post
    where: {
      // 请求参数
      access_token: layui.data(layui.setter.tableName).access_token,
      status: 1
    },
    parseData: function(res){
      // 解析服务端返回的数据
      return {
        "code": res.code,
        "msg": res.msg,
        "count": res.count,
        "data": res.data
      };
    },
    request: {
      pageName: 'page', // 页码的参数名称
      limitName: 'limit' // 每页数据量的参数名
    },
    response: {
      statusCode: 0 // 规定成功的状态码
    },
    cols: [[
      {field: 'id', title: 'ID'},
      {field: 'name', title: '名称'},
      {field: 'createTime', title: '创建时间'}
    ]],
    page: true,
    done: function(res){
      // 表格渲染完成回调
      console.log('表格数据:', res);
    }
  });

  // ============================================
  // 7. 表单提交示例
  // ============================================
  form.on('submit(saveBtn)', function(data){
    var formData = data.field;

    // 添加额外参数
    formData.extraParam = 'value';

    admin.req({
      type: 'post',
      url: layui.setter.baseUrl + '/api/save',
      data: formData,
      done: function(res){
        // admin.req 的 done 回调
        // 注意：done 在 success 之后执行
        if(res.code == 0){
          layer.msg('保存成功', {icon: 1}, function(){
            // 关闭弹窗并刷新父页面
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
            parent.layui.table.reload('tableReload');
          });
        }
      }
    });

    return false; // 阻止表单跳转
  });

  // ============================================
  // 8. 带超时的请求
  // ============================================
  admin.req({
    type: 'get',
    url: layui.setter.baseUrl + '/api/slowApi',
    timeout: 1000 * 60, // 60秒超时
    success: function(res){
      console.log('响应数据:', res);
    }
  });

  // ============================================
  // 9. 文件上传请求
  // ============================================
  function uploadFile(file) {
    var formData = new FormData();
    formData.append('file', file);

    admin.req({
      type: 'post',
      url: layui.setter.baseUrl + '/api/upload',
      data: formData,
      contentType: false,
      processData: false,
      success: function(res){
        if(res.code == 0){
          layer.msg('上传成功', {icon: 1});
          // 处理返回的文件URL
          console.log('文件URL:', res.data.fileUrl);
        }
      }
    });
  }

  // ============================================
  // 10. 数据统计请求
  // ============================================
  function loadStatistics() {
    admin.req({
      type: 'get',
      url: layui.setter.baseUrl + '/api/statistics',
      data: {
        createTimeStart: $('#createTimeStart').val(),
        createTimeEnd: $('#createTimeEnd').val(),
        status: $('#status').val()
      },
      success: function(res){
        if(res.code == 0){
          // 更新统计数据
          $('#totalCount').html(res.data.totalCount);
          $('#totalAmount').html('￥' + res.data.totalAmount);
          $('#successRate').html(res.data.successRate + '%');
        }
      }
    });
  }

  // ============================================
  // 11. 级联下拉框示例
  // ============================================
  // 省份改变时，加载城市列表
  form.on('select(province)', function(data){
    var provinceId = data.value;

    admin.req({
      type: 'get',
      url: layui.setter.baseUrl + '/api/getCities',
      data: {provinceId: provinceId},
      success: function(res){
        if(res.code == 0){
          // 清空并重新填充城市下拉框
          var citySelect = $('select[name="city"]');
          citySelect.empty();
          citySelect.append('<option value="">请选择</option>');
          res.data.forEach(function(city){
            citySelect.append('<option value="' + city.id + '">' + city.name + '</option>');
          });
          form.render('select');
        }
      }
    });
  });

  // ============================================
  // 12. 完整的 CRUD 示例
  // ============================================

  // CREATE - 新增
  function createData(formData) {
    admin.req({
      type: 'post',
      url: layui.setter.baseUrl + '/api/create',
      data: formData,
      success: function(res){
        if(res.code == 0){
          layer.msg('新增成功', {icon: 1});
          table.reload('tableReload');
        } else {
          layer.msg(res.msg || '新增失败', {icon: 2});
        }
      }
    });
  }

  // READ - 读取详情
  function getDetail(id) {
    admin.req({
      type: 'get',
      url: layui.setter.baseUrl + '/api/detail',
      data: {id: id},
      success: function(res){
        if(res.code == 0){
          // 填充表单
          form.val('detailForm', res.data);
        }
      }
    });
  }

  // UPDATE - 更新
  function updateData(formData) {
    admin.req({
      type: 'post',
      url: layui.setter.baseUrl + '/api/update',
      data: formData,
      success: function(res){
        if(res.code == 0){
          layer.msg('更新成功', {icon: 1});
          table.reload('tableReload');
        } else {
          layer.msg(res.msg || '更新失败', {icon: 2});
        }
      }
    });
  }

  // DELETE - 删除
  function removeData(id) {
    layer.confirm('确定删除？', function(index){
      admin.req({
        type: 'post',
        url: layui.setter.baseUrl + '/api/delete',
        data: {id: id},
        success: function(res){
          if(res.code == 0){
            layer.msg('删除成功', {icon: 1});
            layer.close(index);
            table.reload('tableReload');
          }
        }
      });
    });
  }

  // ============================================
  // 13. 标准错误处理
  // ============================================
  function apiRequest(url, data, successCallback) {
    admin.req({
      type: 'post',
      url: layui.setter.baseUrl + url,
      data: data,
      success: function(res){
        if(res.code == 0){
          successCallback && successCallback(res.data);
        } else if(res.code == 401){
          // 未登录或登录过期
          layer.alert('登录已过期，请重新登录', {icon: 2}, function(){
            location.href = layui.setter.baseLocal + 'user/login';
          });
        } else if(res.code == 403){
          // 无权限
          layer.msg('没有操作权限', {icon: 2});
        } else {
          layer.msg(res.msg || '操作失败', {icon: 2});
        }
      },
      error: function(xhr){
        if(xhr.status == 0){
          layer.msg('网络连接失败，请检查网络', {icon: 2});
        } else if(xhr.status == 500){
          layer.msg('服务器错误，请稍后重试', {icon: 2});
        } else if(xhr.status == 404){
          layer.msg('请求的资源不存在', {icon: 2});
        } else {
          layer.msg('请求失败：' + xhr.status, {icon: 2});
        }
      }
    });
  }

});
</script>

</body>
</html>
