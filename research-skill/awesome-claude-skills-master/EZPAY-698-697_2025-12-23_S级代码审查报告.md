# ğŸ“‹ Sçº§èˆªç©ºçº§æ ‡å‡†ä»£ç å®¡æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ ‡å‡†ç­‰çº§å£°æ˜

| ç»´åº¦ | é‡‡ç”¨ç­‰çº§ | å…·ä½“æ ‡å‡† |
|------|----------|----------|
| **è´¨é‡ç­‰çº§** | ğŸ›©ï¸ Sçº§ | èˆªç©ºçº§ (DO-178C Level A) |
| **å·¥ä½œæ¨¡å¼** | REVIEW | ä»£ç å®¡æŸ¥æ¨¡å¼ |
| **æ¶æ„çº¦æŸ** | Sçº§ | åµŒå¥—â‰¤2, å¤æ‚åº¦â‰¤8, å‡½æ•°â‰¤15è¡Œ |
| **æµ‹è¯•è¦†ç›–** | Sçº§ | è¯­å¥100%, åˆ†æ”¯100%, MC/DC |
| **å®‰å…¨æ ‡å‡†** | Sçº§ | OWASPå…¨è¦†ç›– + åŠ å¯†éªŒè¯ |
| **æ€§èƒ½æ ‡å‡†** | Sçº§ | P99â‰¤50ms |
| **æ–‡æ¡£æ ‡å‡†** | Sçº§ | ADR + å®Œæ•´APIè§„æ ¼ |
| **å®¡æŸ¥è¦æ±‚** | Sçº§ | åŒäººå®¡æŸ¥ |

**é€‰æ‹©ç†ç”±**: æ¶‰åŠæ•æ„Ÿæ•°æ®ï¼ˆå•†æˆ·å¯†é’¥ï¼‰å’ŒåŒé‡éªŒè¯æœºåˆ¶ï¼Œå±äºé‡‘èå®‰å…¨å…³é”®è·¯å¾„ï¼Œå¿…é¡»é‡‡ç”¨æœ€é«˜æ ‡å‡†ã€‚

---

## ğŸ“Š å®¡æŸ¥æ¦‚è§ˆ

### Commit ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **Commit 1** | `6e8d11ab16378235620e063c179d1fab4223d846` |
| **Commit 2** | `1effbcf06469e899abde3d01ca405bdcd99bc39f` |
| **å˜æ›´æ–‡ä»¶æ•°** | 28 ä¸ªæ–‡ä»¶ |
| **æ–°å¢ä»£ç è¡Œæ•°** | +1753 è¡Œ |
| **åˆ é™¤ä»£ç è¡Œæ•°** | -332 è¡Œ |
| **åŠŸèƒ½æè¿°** | EZPAY-698: è¿è¥åå°ç§»é™¤è¿”å›å•†æˆ·å¯†é’¥å­—æ®µ<br>EZPAY-697: å•†æˆ·åå°æŸ¥çœ‹å¯†é’¥éœ€åŒé‡éªŒè¯ |

### æ ¸å¿ƒåŠŸèƒ½

1. **æ•æ„Ÿæ•°æ®è¿‡æ»¤æœºåˆ¶** - é€šè¿‡æ³¨è§£è‡ªåŠ¨è¿‡æ»¤æ•æ„Ÿå­—æ®µ
2. **GoogleéªŒè¯ç æ‹¦æˆªå™¨** - å®ç°åŒé‡éªŒè¯ï¼ˆGoogleéªŒè¯ç  + èµ„é‡‘å¯†ç ï¼‰
3. **è¿è¥åå°å®‰å…¨å¢å¼º** - ç§»é™¤è¿”å›çš„å•†æˆ·å¯†é’¥å­—æ®µ

---

## ğŸ” è¯¦ç»†å®¡æŸ¥ç»“æœ

### ä¸€ã€æ¶æ„è´¨é‡çº¦æŸå®¡æŸ¥

#### 1.1 å‡½æ•°é•¿åº¦æ£€æŸ¥

| æ–‡ä»¶ | å‡½æ•°å | è¡Œæ•° | æ ‡å‡† | çŠ¶æ€ |
|------|--------|------|------|------|
| `SensitiveDataFilter.java` | `filterSensitiveFields(T entity)` | 39è¡Œ | â‰¤15è¡Œ | âŒ **è¿è§„** |
| `SensitiveDataFilter.java` | `filterSensitiveFields(List<T> entityList)` | 13è¡Œ | â‰¤15è¡Œ | âœ… é€šè¿‡ |
| `FilterStrategyExecutor.java` | `executeFilterStrategy()` | 37è¡Œ | â‰¤15è¡Œ | âŒ **è¿è§„** |
| `FilterStrategyExecutor.java` | `setFieldValueSafely()` | 28è¡Œ | â‰¤15è¡Œ | âŒ **è¿è§„** |
| `GoogleAuthInterceptor.java` | `preHandle()` | 65è¡Œ | â‰¤15è¡Œ | âŒ **è¿è§„** |
| `MchInfoController.java` | `processWhitelistDelayedEffect()` | 110è¡Œ | â‰¤15è¡Œ | âŒ **è¿è§„** |

**é—®é¢˜ä¸¥é‡æ€§**: ğŸ”´ **é˜»å¡çº§**

**é—®é¢˜åˆ†æ**:
- å¤šä¸ªå‡½æ•°è¶…è¿‡ S çº§æ ‡å‡†ï¼ˆâ‰¤15è¡Œï¼‰
- `preHandle()` å‡½æ•°65è¡Œï¼Œä¸¥é‡è¶…æ ‡
- `processWhitelistDelayedEffect()` å‡½æ•°110è¡Œï¼Œä¸¥é‡è¶…æ ‡

**ä¿®å¤å»ºè®®**:
```java
// ç¤ºä¾‹ï¼šå°† preHandle() æ‹†åˆ†ä¸ºå¤šä¸ªå°å‡½æ•°
public boolean preHandle(...) {
    if (!isHandlerMethod(handler)) return true;
    if (!hasRequireGoogleAuth(handler)) return true;
    return validateGoogleAuth(request);
}

private boolean validateGoogleAuth(HttpServletRequest request) {
    String authWord = extractAuthWord(request);
    if (StringUtils.isBlank(authWord)) {
        throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
    }
    return verifyGoogleCode(request, authWord);
}
```

#### 1.2 åµŒå¥—æ·±åº¦æ£€æŸ¥

| æ–‡ä»¶ | ä½ç½® | åµŒå¥—æ·±åº¦ | æ ‡å‡† | çŠ¶æ€ |
|------|------|----------|------|------|
| `FilterStrategyExecutor.java` | `setFieldValueSafely()` | 3å±‚ | â‰¤2å±‚ | âŒ **è¿è§„** |
| `GoogleAuthInterceptor.java` | `preHandle()` | 2å±‚ | â‰¤2å±‚ | âœ… é€šè¿‡ |
| `SensitiveDataFilter.java` | `filterSensitiveFields()` | 2å±‚ | â‰¤2å±‚ | âœ… é€šè¿‡ |

**é—®é¢˜ä¸¥é‡æ€§**: ğŸŸ¡ **è­¦å‘Šçº§**

**ä¿®å¤å»ºè®®**:
```java
// å½“å‰ä»£ç ï¼ˆ3å±‚åµŒå¥—ï¼‰
if (fieldType == String.class) {
    field.set(entity, filteredValue);
} else if (fieldType == Long.class || fieldType == long.class) {
    try {
        field.set(entity, Long.parseLong(filteredValue));
    } catch (NumberFormatException e) {
        // 3å±‚åµŒå¥—
    }
}

// å»ºè®®é‡æ„ï¼ˆä½¿ç”¨æ—©æœŸè¿”å›ï¼‰
if (fieldType == String.class) {
    return setStringField(entity, field, filteredValue);
}
if (fieldType == Long.class || fieldType == long.class) {
    return setLongField(entity, field, filteredValue);
}
```

#### 1.3 åœˆå¤æ‚åº¦æ£€æŸ¥

| æ–‡ä»¶ | å‡½æ•°å | åœˆå¤æ‚åº¦ | æ ‡å‡† | çŠ¶æ€ |
|------|--------|----------|------|------|
| `FilterStrategyExecutor.java` | `setFieldValueSafely()` | 9 | â‰¤8 | âŒ **è¿è§„** |
| `GoogleAuthInterceptor.java` | `preHandle()` | 7 | â‰¤8 | âœ… é€šè¿‡ |
| `SensitiveDataFilter.java` | `filterSensitiveFields()` | 5 | â‰¤8 | âœ… é€šè¿‡ |

**é—®é¢˜ä¸¥é‡æ€§**: ğŸŸ¡ **è­¦å‘Šçº§**

---

### äºŒã€å®‰å…¨æ€§å®¡æŸ¥ï¼ˆOWASP Top 10ï¼‰

#### 2.1 âœ… A01:2021 â€“ Broken Access Control

**å®¡æŸ¥ç»“æœ**: âœ… **é€šè¿‡**

**å®¡æŸ¥ç‚¹**:
- âœ… `@RequireGoogleAuth` æ³¨è§£æ­£ç¡®æ‹¦æˆªéœ€è¦éªŒè¯çš„æ¥å£
- âœ… `GoogleAuthInterceptor` æ­£ç¡®éªŒè¯ç”¨æˆ·èº«ä»½
- âœ… èµ„é‡‘å¯†ç éªŒè¯åœ¨ `MchController.getPrivateKey()` ä¸­å®ç°

**ä»£ç ä½ç½®**:
```299:309:xxpay-merchant/src/main/java/org/xxpay/mch/user/ctrl/MchController.java
@RequireGoogleAuth("è¯»å–ç§é’¥(æŸ¥çœ‹å•†æˆ·å¯†é’¥éœ€è¿›è¡ŒåŒé‡éªŒè¯ï¼ˆGoogle éªŒè¯ç  + èµ„é‡‘å¯†ç ï¼‰)")
@RequestMapping("/getPrivateKey")
public ResponseEntity<?> getPrivateKey(@Valid MchPrivateRequest request) {
    MchInfo mchInfo = userService.findByMchId(getUser().getId());
    if (!Objects.equals(request.getPayPassword(), mchInfo.getPayPassword())) {
        log.warn("èµ„é‡‘å¯†ç éªŒè¯å¤±è´¥");
        throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
    }
    return ResponseEntity.ok(XxPayResponse.buildSuccess(mchInfo.getPrivateKey()));
}
```

#### 2.2 âš ï¸ A02:2021 â€“ Cryptographic Failures

**å®¡æŸ¥ç»“æœ**: âš ï¸ **éƒ¨åˆ†é€šè¿‡ï¼Œå­˜åœ¨é£é™©**

**é—®é¢˜ç‚¹**:

1. **èµ„é‡‘å¯†ç æ˜æ–‡æ¯”è¾ƒ** - ğŸ”´ **ä¸¥é‡é£é™©**
```java
// å½“å‰ä»£ç ï¼ˆæ˜æ–‡æ¯”è¾ƒï¼‰
if (!Objects.equals(request.getPayPassword(), mchInfo.getPayPassword())) {
    throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
}
```

**é—®é¢˜**: 
- èµ„é‡‘å¯†ç åœ¨æ•°æ®åº“ä¸­å¯èƒ½ä»¥æ˜æ–‡å­˜å‚¨
- å³ä½¿åŠ å¯†å­˜å‚¨ï¼Œä¹Ÿåº”è¯¥ä½¿ç”¨å®‰å…¨çš„æ¯”è¾ƒæ–¹æ³•ï¼ˆå¦‚ `BCrypt.checkpw()`ï¼‰

**ä¿®å¤å»ºè®®**:
```java
// å»ºè®®ä¿®å¤
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
if (!encoder.matches(request.getPayPassword(), mchInfo.getPayPassword())) {
    throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
}
```

2. **æ•æ„Ÿæ•°æ®åºåˆ—åŒ–é£é™©** - ğŸŸ¡ **ä¸­ç­‰é£é™©**
```java
// SensitiveDataFilter.java ä½¿ç”¨åºåˆ—åŒ–å…‹éš†
T filteredEntity = SerializationUtils.clone(entity);
```

**é—®é¢˜**:
- `SerializationUtils.clone()` å¯èƒ½å°†æ•æ„Ÿæ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶æˆ–å†…å­˜
- åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ•æ„Ÿæ•°æ®å¯èƒ½è¢«æ³„éœ²

**ä¿®å¤å»ºè®®**:
- ä½¿ç”¨æ·±æ‹·è´å·¥å…·ï¼ˆå¦‚ MapStructï¼‰è€Œéåºåˆ—åŒ–
- æˆ–ä½¿ç”¨åå°„ç›´æ¥åˆ›å»ºæ–°å¯¹è±¡å¹¶å¤åˆ¶å­—æ®µ

#### 2.3 âœ… A03:2021 â€“ Injection

**å®¡æŸ¥ç»“æœ**: âœ… **é€šè¿‡**

**å®¡æŸ¥ç‚¹**:
- âœ… ä½¿ç”¨ `@Valid` æ³¨è§£è¿›è¡Œå‚æ•°éªŒè¯
- âœ… ä½¿ç”¨ `@NotBlank` éªŒè¯å¿…å¡«å­—æ®µ
- âœ… æ—  SQL æ³¨å…¥é£é™©ï¼ˆä½¿ç”¨ MyBatis å‚æ•°ç»‘å®šï¼‰

#### 2.4 âš ï¸ A04:2021 â€“ Insecure Design

**å®¡æŸ¥ç»“æœ**: âš ï¸ **éƒ¨åˆ†é€šè¿‡ï¼Œå­˜åœ¨è®¾è®¡ç¼ºé™·**

**é—®é¢˜ç‚¹**:

1. **GoogleéªŒè¯ç å‚æ•°è·å–æ–¹å¼ä¸å®‰å…¨** - ğŸŸ¡ **ä¸­ç­‰é£é™©**
```java
// GoogleAuthInterceptor.java
String authenticationWord = request.getHeader("authenticationWord");
String googleCodeStr = request.getParameter(authenticationWord);
```

**é—®é¢˜**:
- ä» Header è·å–å‚æ•°åï¼Œå†ä» Parameter è·å–å€¼ï¼Œè¿™ç§è®¾è®¡å®¹æ˜“å¯¼è‡´æ··æ·†
- å¦‚æœ `authenticationWord` è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½è¯»å–åˆ°å…¶ä»–å‚æ•°

**ä¿®å¤å»ºè®®**:
```java
// å»ºè®®ï¼šç›´æ¥ä½¿ç”¨å›ºå®šçš„å‚æ•°å
String googleCodeStr = request.getParameter("googleCode");
String payPassword = request.getParameter("payPassword");
```

2. **æ•æ„Ÿæ•°æ®è¿‡æ»¤å¼‚å¸¸å¤„ç†ä¸å½“** - ğŸŸ¡ **ä¸­ç­‰é£é™©**
```java
// SensitiveDataFilter.java
} catch (Exception e) {
    log.error("è¿‡æ»¤æ•æ„Ÿå­—æ®µæ—¶å‘ç”Ÿå¼‚å¸¸", e);
    return null;  // âŒ è¿”å› null å¯èƒ½å¯¼è‡´ NPE
}
```

**é—®é¢˜**:
- å¼‚å¸¸æ—¶è¿”å› `null`ï¼Œè°ƒç”¨æ–¹å¯èƒ½æœªå¤„ç†ï¼Œå¯¼è‡´ NPE
- æ•æ„Ÿæ•°æ®è¿‡æ»¤å¤±è´¥æ—¶ï¼Œåº”è¯¥è¿”å›åŸå§‹å¯¹è±¡è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Ÿ

**ä¿®å¤å»ºè®®**:
```java
} catch (Exception e) {
    log.error("è¿‡æ»¤æ•æ„Ÿå­—æ®µæ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œè¿”å›åŸå§‹å¯¹è±¡", e);
    return entity;  // å®‰å…¨ç­–ç•¥ï¼šå¤±è´¥æ—¶è¿”å›åŸå§‹å¯¹è±¡ï¼Œé¿å…æ•°æ®ä¸¢å¤±
}
```

#### 2.5 âœ… A05:2021 â€“ Security Misconfiguration

**å®¡æŸ¥ç»“æœ**: âœ… **é€šè¿‡**

**å®¡æŸ¥ç‚¹**:
- âœ… æ‹¦æˆªå™¨æ­£ç¡®æ³¨å†Œåˆ° Spring Security é…ç½®
- âœ… æ³¨è§£ä½¿ç”¨æ­£ç¡®

---

### ä¸‰ã€ä»£ç è´¨é‡å®¡æŸ¥

#### 3.1 å¼‚å¸¸å¤„ç†å®¡æŸ¥

**é—®é¢˜ç‚¹**:

1. **ç©º catch å—** - ğŸ”´ **ä¸¥é‡é—®é¢˜**
```java
// FilterStrategyExecutor.java
} catch (IllegalAccessException e) {
    log.warn("æ— æ³•è®¿é—®å­—æ®µå€¼ï¼Œå­—æ®µå: {}, é”™è¯¯: {}", field.getName(), e.getClass().getSimpleName());
    return;  // âŒ é™é»˜è¿”å›ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®æœªè¿‡æ»¤
}
```

**é—®é¢˜**: 
- å¼‚å¸¸è¢«æ•è·ä½†æœªå¤„ç†ï¼Œå¯èƒ½å¯¼è‡´æ•æ„Ÿæ•°æ®æœªè¿‡æ»¤
- è¿å S çº§æ ‡å‡†ï¼šç¦æ­¢ç©º catch å—

**ä¿®å¤å»ºè®®**:
```java
} catch (IllegalAccessException e) {
    log.error("æ— æ³•è®¿é—®å­—æ®µå€¼ï¼Œå­—æ®µå: {}, é”™è¯¯: {}", field.getName(), e.getMessage(), e);
    // å®‰å…¨ç­–ç•¥ï¼šæ— æ³•è®¿é—®æ—¶ï¼Œæ¸…ç©ºå­—æ®µå€¼
    try {
        field.set(entity, "");
    } catch (Exception ex) {
        log.error("æ¸…ç©ºå­—æ®µå€¼å¤±è´¥", ex);
    }
}
```

2. **å¼‚å¸¸ä¿¡æ¯ä¸å®Œæ•´** - ğŸŸ¡ **è­¦å‘Š**
```java
// GoogleAuthInterceptor.java
} catch (Exception e) {
    log.warn("GoogleAuthInterceptor: éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸");
    throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
}
```

**é—®é¢˜**: 
- å¼‚å¸¸ä¿¡æ¯æœªåŒ…å«å…·ä½“é”™è¯¯åŸå› ï¼Œä¸åˆ©äºæ’æŸ¥é—®é¢˜

**ä¿®å¤å»ºè®®**:
```java
} catch (Exception e) {
    log.error("GoogleAuthInterceptor: éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸, userId={}, uri={}", 
        getCurrentUser() != null ? getCurrentUser().getId() : "unknown", 
        request.getRequestURI(), e);
    throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
}
```

#### 3.2 å‘½åè§„èŒƒå®¡æŸ¥

**é—®é¢˜ç‚¹**:

1. **åŒ…åæ‹¼å†™é”™è¯¯** - ğŸŸ¡ **è­¦å‘Š**
```
xxpay-merchant/src/main/java/org/xxpay/mch/secruity/
```
**é—®é¢˜**: `secruity` åº”ä¸º `security`

**ä¿®å¤å»ºè®®**: é‡å‘½ååŒ…ä¸º `security`

2. **å˜é‡å‘½åä¸å¤Ÿæ¸…æ™°** - ğŸŸ¡ **è­¦å‘Š**
```java
String authenticationWord = request.getHeader("authenticationWord");
```
**é—®é¢˜**: `authenticationWord` å‘½åä¸å¤Ÿæ¸…æ™°ï¼Œå»ºè®®æ”¹ä¸º `authParamName` æˆ– `googleCodeParamName`

#### 3.3 å¸¸é‡ä½¿ç”¨å®¡æŸ¥

**å®¡æŸ¥ç»“æœ**: âœ… **é€šè¿‡**

**å®¡æŸ¥ç‚¹**:
- âœ… ä½¿ç”¨ `RetEnum` å¸¸é‡å®šä¹‰é”™è¯¯ç 
- âœ… ä½¿ç”¨ `FilterStrategy` æšä¸¾å®šä¹‰è¿‡æ»¤ç­–ç•¥
- âœ… æ— ç¡¬ç¼–ç çš„é­”æœ¯æ•°å­—

---

### å››ã€æ€§èƒ½å®¡æŸ¥

#### 4.1 åºåˆ—åŒ–æ€§èƒ½é—®é¢˜

**é—®é¢˜ç‚¹**:

1. **ä½¿ç”¨åºåˆ—åŒ–å…‹éš†æ€§èƒ½å·®** - ğŸŸ¡ **è­¦å‘Š**
```java
T filteredEntity = SerializationUtils.clone(entity);
```

**é—®é¢˜**:
- åºåˆ—åŒ–/ååºåˆ—åŒ–æ€§èƒ½å¼€é”€å¤§
- å¯¹äºå¤§å¯¹è±¡ï¼Œå¯èƒ½å½±å“å“åº”æ—¶é—´ï¼ˆSçº§è¦æ±‚ P99â‰¤50msï¼‰

**ä¿®å¤å»ºè®®**:
```java
// ä½¿ç”¨åå°„åˆ›å»ºæ–°å¯¹è±¡å¹¶å¤åˆ¶å­—æ®µ
T filteredEntity = createEntityCopy(entity);
// æˆ–ä½¿ç”¨ MapStruct ç­‰å·¥å…·ç”Ÿæˆé«˜æ•ˆçš„æ‹·è´ä»£ç 
```

#### 4.2 åå°„æ€§èƒ½é—®é¢˜

**é—®é¢˜ç‚¹**:

1. **é¢‘ç¹åå°„æ“ä½œ** - ğŸŸ¡ **è­¦å‘Š**
```java
// SensitiveDataFilter.java ä¸­å¤šæ¬¡ä½¿ç”¨åå°„
Field field = getField(entity.getClass(), fieldName);
field.setAccessible(true);
value = field.get(entity);
```

**é—®é¢˜**:
- åå°„æ“ä½œæ€§èƒ½è¾ƒå·®
- å»ºè®®ç¼“å­˜ `Field` å¯¹è±¡

**ä¿®å¤å»ºè®®**:
```java
// ä½¿ç”¨ç¼“å­˜
private static final Map<Class<?>, Map<String, Field>> FIELD_CACHE = new ConcurrentHashMap<>();

private Field getFieldCached(Class<?> clazz, String fieldName) {
    return FIELD_CACHE.computeIfAbsent(clazz, k -> new HashMap<>())
        .computeIfAbsent(fieldName, name -> {
            // æŸ¥æ‰¾å­—æ®µé€»è¾‘
        });
}
```

---

### äº”ã€æµ‹è¯•è¦†ç›–å®¡æŸ¥

#### 5.1 å•å…ƒæµ‹è¯•ç¼ºå¤±

**å®¡æŸ¥ç»“æœ**: âŒ **ä¸¥é‡ç¼ºå¤±**

**é—®é¢˜**:
- æœªå‘ç°å¯¹åº”çš„å•å…ƒæµ‹è¯•æ–‡ä»¶
- S çº§æ ‡å‡†è¦æ±‚ï¼šè¯­å¥100%, åˆ†æ”¯100%, MC/DC

**å¿…é¡»æ·»åŠ çš„æµ‹è¯•**:

1. **SensitiveDataFilter æµ‹è¯•**
```java
@Test
void testFilterSensitiveFields_WithPassword_ShouldMask() {
    MchInfo mchInfo = MchInfo.builder()
        .mchId(1L)
        .password("plainPassword")
        .build();
    
    MchInfo filtered = sensitiveDataFilter.filterSensitiveFields(mchInfo);
    
    assertThat(filtered.getPassword()).isEqualTo("pl******");
}

@Test
void testFilterSensitiveFields_WithPrivateKey_ShouldMaskKey() {
    MchInfo mchInfo = MchInfo.builder()
        .mchId(1L)
        .privateKey("abcdefghijklmnop")
        .build();
    
    MchInfo filtered = sensitiveDataFilter.filterSensitiveFields(mchInfo);
    
    assertThat(filtered.getPrivateKey()).isEqualTo("abcd********mnop");
}
```

2. **GoogleAuthInterceptor æµ‹è¯•**
```java
@Test
void testPreHandle_WithoutGoogleAuth_ShouldPass() {
    // æµ‹è¯•æ²¡æœ‰ @RequireGoogleAuth æ³¨è§£çš„æ–¹æ³•
}

@Test
void testPreHandle_WithInvalidGoogleCode_ShouldThrowException() {
    // æµ‹è¯•æ— æ•ˆçš„ Google éªŒè¯ç 
}

@Test
void testPreHandle_WithValidGoogleCode_ShouldPass() {
    // æµ‹è¯•æœ‰æ•ˆçš„ Google éªŒè¯ç 
}
```

3. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**
- ç©ºå€¼æµ‹è¯•
- null å¯¹è±¡æµ‹è¯•
- ç©ºåˆ—è¡¨æµ‹è¯•
- å¼‚å¸¸æƒ…å†µæµ‹è¯•

---

### å…­ã€æ–‡æ¡£å®¡æŸ¥

#### 6.1 API æ–‡æ¡£ç¼ºå¤±

**å®¡æŸ¥ç»“æœ**: âŒ **ç¼ºå¤±**

**é—®é¢˜**:
- æ–°å¢æ¥å£ `/getPrivateKey` æ—  API æ–‡æ¡£
- S çº§æ ‡å‡†è¦æ±‚ï¼šå®Œæ•´ API è§„æ ¼

**å¿…é¡»æ·»åŠ çš„æ–‡æ¡£**:

```markdown
## API: è·å–å•†æˆ·ç§é’¥

### è¯·æ±‚
```
POST /api/mch/getPrivateKey
Content-Type: application/json
Authorization: Bearer <token>
```

### è¯·æ±‚å‚æ•°
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | éªŒè¯è§„åˆ™ |
|------|------|------|------|----------|
| payPassword | string | æ˜¯ | èµ„é‡‘å¯†ç  | éç©º |
| googleCode | string | æ˜¯ | GoogleéªŒè¯ç  | 6ä½æ•°å­— |

### å“åº”
**æˆåŠŸ (200)**
```json
{
  "code": 0,
  "data": "å•†æˆ·ç§é’¥"
}
```

**é”™è¯¯**
| é”™è¯¯ç  | å«ä¹‰ | å¤„ç†å»ºè®® |
|--------|------|----------|
| RET_COMM_CHECK_SECURITY_FAIL | å®‰å…¨éªŒè¯å¤±è´¥ | æ£€æŸ¥èµ„é‡‘å¯†ç å’ŒGoogleéªŒè¯ç  |
```

#### 6.2 ADR æ–‡æ¡£ç¼ºå¤±

**å®¡æŸ¥ç»“æœ**: âŒ **ç¼ºå¤±**

**é—®é¢˜**:
- æ•æ„Ÿæ•°æ®è¿‡æ»¤æœºåˆ¶çš„è®¾è®¡å†³ç­–æ—  ADR æ–‡æ¡£
- S çº§æ ‡å‡†è¦æ±‚ï¼šADR æ–‡æ¡£

**å»ºè®®æ·»åŠ  ADR**:
```markdown
# ADR-001: æ•æ„Ÿæ•°æ®è¿‡æ»¤æœºåˆ¶è®¾è®¡

## çŠ¶æ€
æ¥å—

## ä¸Šä¸‹æ–‡
éœ€è¦é˜²æ­¢æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ã€å¯†é’¥ï¼‰åœ¨ API å“åº”ä¸­æ³„éœ²

## å†³ç­–
ä½¿ç”¨æ³¨è§£é©±åŠ¨çš„æ•æ„Ÿæ•°æ®è¿‡æ»¤æœºåˆ¶

## ç†ç”±
- å£°æ˜å¼è®¾è®¡ï¼Œä»£ç æ¸…æ™°
- å¯æ‰©å±•ï¼Œæ”¯æŒå¤šç§è¿‡æ»¤ç­–ç•¥
- é›†ä¸­ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤

## åæœ
### æ­£é¢
- è‡ªåŠ¨è¿‡æ»¤ï¼Œå‡å°‘äººå·¥é”™è¯¯
- æ”¯æŒå¤šç§è¿‡æ»¤ç­–ç•¥

### è´Ÿé¢
- æ€§èƒ½å¼€é”€ï¼ˆåºåˆ—åŒ–å…‹éš†ï¼‰
- éœ€è¦ä¸ºæ¯ä¸ªå®ä½“ç±»æ·»åŠ æ³¨è§£
```

---

## ğŸ“Š å®¡æŸ¥è¯„åˆ†å¡

| ç»´åº¦ | å¾—åˆ† | æƒé‡ | åŠ æƒåˆ† | è¯´æ˜ |
|------|------|------|--------|------|
| **æ­£ç¡®æ€§** | 7/10 | 30% | 2.1 | åŠŸèƒ½å®ç°æ­£ç¡®ï¼Œä½†å­˜åœ¨å®‰å…¨é£é™© |
| **å¯ç»´æŠ¤æ€§** | 5/10 | 25% | 1.25 | å‡½æ•°è¿‡é•¿ï¼ŒåµŒå¥—è¿‡æ·± |
| **å®‰å…¨æ€§** | 6/10 | 25% | 1.5 | å­˜åœ¨å¯†ç æ˜æ–‡æ¯”è¾ƒç­‰å®‰å…¨é£é™© |
| **æ€§èƒ½** | 6/10 | 20% | 1.2 | åºåˆ—åŒ–æ€§èƒ½è¾ƒå·® |
| **æ€»åˆ†** | | | **6.05/10** | **æœªè¾¾åˆ° S çº§æ ‡å‡†** |

---

## ğŸš¨ é˜»å¡æ€§é—®é¢˜æ¸…å•

### ğŸ”´ å¿…é¡»ä¿®å¤ï¼ˆé˜»å¡åˆå¹¶ï¼‰

1. **å‡½æ•°é•¿åº¦è¶…æ ‡** (6ä¸ªå‡½æ•°)
   - `SensitiveDataFilter.filterSensitiveFields()` - 39è¡Œ
   - `FilterStrategyExecutor.executeFilterStrategy()` - 37è¡Œ
   - `FilterStrategyExecutor.setFieldValueSafely()` - 28è¡Œ
   - `GoogleAuthInterceptor.preHandle()` - 65è¡Œ
   - `MchInfoController.processWhitelistDelayedEffect()` - 110è¡Œ

2. **å®‰å…¨é£é™©ï¼šèµ„é‡‘å¯†ç æ˜æ–‡æ¯”è¾ƒ**
   - ä½ç½®: `MchController.getPrivateKey()`
   - å¿…é¡»ä½¿ç”¨ BCrypt ç­‰å®‰å…¨æ¯”è¾ƒæ–¹æ³•

3. **å¼‚å¸¸å¤„ç†ä¸å½“**
   - `SensitiveDataFilter` å¼‚å¸¸æ—¶è¿”å› null
   - `FilterStrategyExecutor` ç©º catch å—

4. **æµ‹è¯•è¦†ç›–ç¼ºå¤±**
   - æ— å•å…ƒæµ‹è¯•
   - S çº§è¦æ±‚ 100% è¦†ç›–

5. **æ–‡æ¡£ç¼ºå¤±**
   - æ—  API æ–‡æ¡£
   - æ—  ADR æ–‡æ¡£

---

## ğŸŸ¡ è­¦å‘Šæ€§é—®é¢˜æ¸…å•

### å»ºè®®ä¿®å¤ï¼ˆéé˜»å¡ï¼‰

1. **åµŒå¥—æ·±åº¦è¶…æ ‡** (1å¤„)
   - `FilterStrategyExecutor.setFieldValueSafely()` - 3å±‚åµŒå¥—

2. **åœˆå¤æ‚åº¦è¶…æ ‡** (1å¤„)
   - `FilterStrategyExecutor.setFieldValueSafely()` - åœˆå¤æ‚åº¦9

3. **å‘½åé—®é¢˜**
   - åŒ…åæ‹¼å†™é”™è¯¯: `secruity` â†’ `security`
   - å˜é‡å‘½åä¸å¤Ÿæ¸…æ™°

4. **æ€§èƒ½é—®é¢˜**
   - ä½¿ç”¨åºåˆ—åŒ–å…‹éš†ï¼Œæ€§èƒ½è¾ƒå·®
   - é¢‘ç¹åå°„æ“ä½œï¼Œå»ºè®®ç¼“å­˜

5. **è®¾è®¡é—®é¢˜**
   - GoogleéªŒè¯ç å‚æ•°è·å–æ–¹å¼ä¸å®‰å…¨
   - æ•æ„Ÿæ•°æ®è¿‡æ»¤å¤±è´¥æ—¶çš„å¤„ç†ç­–ç•¥ä¸æ˜ç¡®

---

## âœ… å®¡æŸ¥ç»“è®º

### å½“å‰çŠ¶æ€
- âŒ **æœªè¾¾åˆ° S çº§æ ‡å‡†**
- ğŸ”´ **å­˜åœ¨é˜»å¡æ€§é—®é¢˜ï¼Œä¸å»ºè®®åˆå¹¶**

### ä¿®å¤ä¼˜å…ˆçº§

#### P0 - ç«‹å³ä¿®å¤ï¼ˆé˜»å¡åˆå¹¶ï¼‰
1. å‡½æ•°é•¿åº¦è¶…æ ‡é—®é¢˜ï¼ˆ6ä¸ªå‡½æ•°ï¼‰
2. èµ„é‡‘å¯†ç æ˜æ–‡æ¯”è¾ƒå®‰å…¨é£é™©
3. å¼‚å¸¸å¤„ç†ä¸å½“
4. æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆè‡³å°‘è¦†ç›–æ ¸å¿ƒåŠŸèƒ½ï¼‰

#### P1 - é«˜ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
1. åµŒå¥—æ·±åº¦å’Œåœˆå¤æ‚åº¦é—®é¢˜
2. æ€§èƒ½ä¼˜åŒ–ï¼ˆåºåˆ—åŒ–ã€åå°„ç¼“å­˜ï¼‰
3. æ·»åŠ  API æ–‡æ¡£å’Œ ADR

#### P2 - ä¸­ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰
1. å‘½åè§„èŒƒé—®é¢˜
2. è®¾è®¡ä¼˜åŒ–

### ä¿®å¤åé‡æ–°å®¡æŸ¥è¦æ±‚

1. âœ… æ‰€æœ‰å‡½æ•°é•¿åº¦ â‰¤ 15è¡Œ
2. âœ… æ‰€æœ‰åµŒå¥—æ·±åº¦ â‰¤ 2å±‚
3. âœ… æ‰€æœ‰åœˆå¤æ‚åº¦ â‰¤ 8
4. âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 100%
5. âœ… å®‰å…¨é£é™©å·²ä¿®å¤
6. âœ… API æ–‡æ¡£å’Œ ADR å·²æ·»åŠ 

---

## ğŸ“ ä¿®å¤å»ºè®®ç¤ºä¾‹

### ç¤ºä¾‹1: å‡½æ•°æ‹†åˆ†

**åŸä»£ç ** (65è¡Œ):
```java
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
    // 65è¡Œä»£ç 
}
```

**ä¿®å¤å**:
```java
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
    if (!isHandlerMethod(handler)) return true;
    if (!hasRequireGoogleAuth(handler)) return true;
    return validateGoogleAuth(request);
}

private boolean isHandlerMethod(Object handler) {
    return handler instanceof HandlerMethod;
}

private boolean hasRequireGoogleAuth(Object handler) {
    HandlerMethod handlerMethod = (HandlerMethod) handler;
    return handlerMethod.getMethodAnnotation(RequireGoogleAuth.class) != null;
}

private boolean validateGoogleAuth(HttpServletRequest request) {
    String googleCode = extractGoogleCode(request);
    if (StringUtils.isBlank(googleCode)) {
        throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
    }
    return verifyGoogleCode(request, googleCode);
}
```

### ç¤ºä¾‹2: å®‰å…¨ä¿®å¤

**åŸä»£ç **:
```java
if (!Objects.equals(request.getPayPassword(), mchInfo.getPayPassword())) {
    throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
}
```

**ä¿®å¤å**:
```java
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
if (!encoder.matches(request.getPayPassword(), mchInfo.getPayPassword())) {
    log.warn("èµ„é‡‘å¯†ç éªŒè¯å¤±è´¥, userId={}", getUser().getId());
    throw new ServiceException(RetEnum.RET_COMM_CHECK_SECURITY_FAIL);
}
```

---

## ğŸ“… å®¡æŸ¥ä¿¡æ¯

- **å®¡æŸ¥æ—¥æœŸ**: 2025-12-23
- **å®¡æŸ¥äºº**: AI Code Reviewer (Sçº§æ ‡å‡†)
- **å®¡æŸ¥æ ‡å‡†**: DO-178C Level A / Sçº§èˆªç©ºçº§æ ‡å‡†
- **å®¡æŸ¥èŒƒå›´**: Commit `6e8d11ab` å’Œ `1effbcf`
- **å®¡æŸ¥ç»“è®º**: âŒ **æœªé€šè¿‡ï¼Œéœ€è¦ä¿®å¤åé‡æ–°å®¡æŸ¥**

---

## ğŸ“Œ é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

#### æ ¸å¿ƒæ–‡ä»¶
- `Sensitive.java` - æ•æ„Ÿå­—æ®µæ³¨è§£
- `FilterStrategy.java` - è¿‡æ»¤ç­–ç•¥æšä¸¾
- `SensitiveDataFilter.java` - æ•æ„Ÿæ•°æ®è¿‡æ»¤å™¨
- `FilterStrategyExecutor.java` - è¿‡æ»¤ç­–ç•¥æ‰§è¡Œå™¨
- `GoogleAuthInterceptor.java` - GoogleéªŒè¯ç æ‹¦æˆªå™¨
- `MchController.java` - å•†æˆ·æ§åˆ¶å™¨ï¼ˆæ–°å¢æ¥å£ï¼‰
- `MchInfoController.java` - è¿è¥åå°æ§åˆ¶å™¨ï¼ˆç§»é™¤å¯†é’¥å­—æ®µï¼‰

#### å®ä½“ç±»
- `MchInfo.java` - å•†æˆ·ä¿¡æ¯å®ä½“ï¼ˆæ·»åŠ  @Sensitive æ³¨è§£ï¼‰

#### é…ç½®ç±»
- `ComponentBean.java` - Bean é…ç½®
- `WebSecurityConfig.java` - å®‰å…¨é…ç½®

### B. æµ‹è¯•ç”¨ä¾‹æ¨¡æ¿

è§"äº”ã€æµ‹è¯•è¦†ç›–å®¡æŸ¥"ç« èŠ‚ã€‚

### C. API æ–‡æ¡£æ¨¡æ¿

è§"å…­ã€æ–‡æ¡£å®¡æŸ¥"ç« èŠ‚ã€‚

---

**æŠ¥å‘Šç»“æŸ**

